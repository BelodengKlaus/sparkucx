# See https://aka.ms/yaml

trigger:
  - master
  - v*.*.x
pr:
  - master
  - v*.*.x

stages:
  - stage: Build
    jobs:
      - job: build
        pool:
          name: MLNX
          demands: Maven
        steps:
          - task: Maven@3
            displayName:  build
            inputs:
              jdkVersionOption: "1.8"
              publishJUnitResults: false
              goals: "package"
              options: "-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"
          - bash: |
              set -x
              source buildlib/test.sh

              if [[ $(get_rdma_device_iface) != "" ]]
              then
                export SPARK_UCX_JAR=$(System.DefaultWorkingDirectory)/target/spark-ucx-1.0-for-spark-2.4-jar-with-dependencies.jar
                export SPARK_LOCAL_DIRS=$(System.DefaultWorkingDirectory)/target/spark
                cd $(System.DefaultWorkingDirectory)/target/
                if [[ -d /hpc/local/oss/spark/spark-2.4.4-bin-hadoop2.7 ]]
                then
                        export SPARK_HOME=/hpc/local/oss/spark/spark-2.4.4-bin-hadoop2.7
                fi
                run_tests
              else
                echo ##vso[task.complete result=Skipped;]No IB devices found
              fi
